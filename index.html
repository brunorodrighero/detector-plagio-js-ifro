<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detector de Plágio</title>
    <link rel="shortcut icon" href="favicon.jpg" type="image/jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .custom-file-input {
        display: none;
      }
      .custom-file-label {
        display: inline-block;
        width: 100%;
      }
      .excerpt-content {
        white-space: pre-wrap;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
      }
      .high-similarity {
        background-color: #f8d7da;
      }
      @media (max-width: 768px) {
        .table-responsive {
          overflow-x: auto;
        }
      }
      .logo {
        max-width: 450px;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <div class="text-center">
        <img src="ifro-logo.png" alt="Logo do IFRO" class="logo" />
        <h1 class="mb-4">Detector de Plágio</h1>
      </div>
      <div class="card shadow-sm">
        <div class="card-body">
          <form>
            <div class="row mb-3">
              <div class="col-12">
                <label for="folderInput" class="form-label"
                  >Selecione a <strong>PASTA</strong> com os arquivos para análise:</label>
                <input
                  type="file"
                  class="form-control custom-file-input"
                  id="folderInput"
                  webkitdirectory
                  directory
                  accept=".txt,.pdf,.docx,.doc,.rtf,.odt"
                />
                <label
                  for="folderInput"
                  class="btn btn-outline-secondary custom-file-label"
                  ><i class="bi bi-folder"></i> Escolher pasta</label>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="threshold" class="form-label">Limiar de similaridade (%):</label>
                <input
                  type="number"
                  class="form-control"
                  id="threshold"
                  value="4"
                  min="0"
                  max="100"
                />
              </div>
              <div class="col-md-4">
                <label for="ngramSize" class="form-label">Tamanho do n-grama:</label>
                <select class="form-select" id="ngramSize">
                  <option value="3">3</option>
                  <option value="5" selected>5</option>
                  <option value="7">7</option>
                  <option value="10">10</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="metric" class="form-label">Métrica de similaridade:</label>
                <select class="form-select" id="metric">
                  <option value="jaccard" selected>Jaccard</option>
                  <option value="dice">Dice</option>
                </select>
              </div>
            </div>
            <div class="text-center mb-3">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                id="startButton"
                onclick="startAnalysis()"
              >
                <i class="bi bi-play"></i> Iniciar Análise
              </button>
            </div>
            <div class="d-flex justify-content-center gap-2">
              <button
                type="button"
                class="btn btn-secondary"
                id="cancelButton"
                onclick="cancelAnalysis()"
                disabled
              >
                <i class="bi bi-stop"></i> Cancelar
              </button>
              <button
                type="button"
                class="btn btn-outline-danger"
                id="clearButton"
                onclick="clearForm()"
              >
                <i class="bi bi-trash"></i> Limpar
              </button>
            </div>
          </form>
          <div
            class="progress mt-3"
            role="progressbar"
            aria-label="Progresso da análise"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            <div class="progress-bar" style="width: 0%" id="progress"></div>
          </div>
          <div class="mt-4">
            <div id="summary" class="mb-3"></div>
            <button
              type="button"
              class="btn btn-success mb-3"
              id="exportButton"
              style="display: none"
              onclick="exportToCSV()"
            >
              <i class="bi bi-download"></i> Exportar como CSV
            </button>
            <div class="table-responsive">
              <table
                class="table table-striped table-bordered table-hover"
                id="resultTable"
                style="display: none"
              >
                <thead class="table-light">
                  <tr>
                    <th>Arquivo 1</th>
                    <th>Arquivo 2</th>
                    <th>Métrica</th>
                    <th>Similaridade (%)</th>
                    <th>Trechos Copiados</th>
                  </tr>
                </thead>
                <tbody id="resultBody"></tbody>
              </table>
            </div>
            <div id="noResults" class="alert alert-info mt-3" style="display: none">
              Nenhum caso de plágio foi detectado.
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.8.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/odf@1.0.2/odf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"></script>
    <script>
      let isCancelled = false;
      let worker;

      document.getElementById('folderInput').addEventListener('change', function () {
        const input = this;
        const label = document.querySelector('.custom-file-label');
        if (input.files.length > 0) {
          const folderPath = input.files[0].webkitRelativePath.split('/')[0];
          label.innerHTML = `<i class="bi bi-folder"></i> ${folderPath || 'Pasta selecionada'}`;
        } else {
          label.innerHTML = '<i class="bi bi-folder"></i> Escolher pasta';
        }
      });

      function clearForm() {
        document.getElementById('folderInput').value = '';
        document.getElementById('threshold').value = '4';
        document.getElementById('ngramSize').value = '5';
        document.getElementById('metric').value = 'jaccard';
        document.querySelector('.custom-file-label').innerHTML = '<i class="bi bi-folder"></i> Escolher pasta';
        document.getElementById('summary').innerHTML = '';
        document.getElementById('resultTable').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('exportButton').style.display = 'none';
        document.getElementById('progress').style.width = '0%';
      }

      async function extractText(file) {
        const extension = file.name.split('.').pop().toLowerCase();
        try {
          if (extension === 'txt') return await file.text();
          if (extension === 'pdf') {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
          }
          if (extension === 'docx') {
            const arrayBuffer = await file.arrayBuffer();
            const result = await docx.extractRawText({ arrayBuffer });
            return result.value || '';
          }
          if (extension === 'doc') {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value || '';
          }
          if (extension === 'odt') {
            const arrayBuffer = await file.arrayBuffer();
            const odt = new ODF.ODFDocument(arrayBuffer);
            return odt.getTextContent() || '';
          }
          if (extension === 'rtf') {
            const text = await file.text();
            return text.replace(/\[^ ]+/g, '').replace(/{[^}]+}/g, '').trim() || '';
          }
          throw new Error(`Formato não suportado: ${extension}`);
        } catch (error) {
          throw new Error(`Falha ao extrair texto de ${file.name}: ${error.message}`);
        }
      }

      async function startAnalysis() {
        isCancelled = false;
        const startButton = document.getElementById('startButton');
        const cancelButton = document.getElementById('cancelButton');
        const progress = document.getElementById('progress');
        const resultTable = document.getElementById('resultTable');
        const summaryDiv = document.getElementById('summary');
        const noResultsDiv = document.getElementById('noResults');
        const exportButton = document.getElementById('exportButton');
        const fileInput = document.getElementById('folderInput');
        const threshold = parseFloat(document.getElementById('threshold').value) / 100;
        const ngramSize = parseInt(document.getElementById('ngramSize').value);
        const metric = document.getElementById('metric').value;

        startButton.disabled = true;
        cancelButton.disabled = false;
        resultTable.style.display = 'none';
        noResultsDiv.style.display = 'none';
        summaryDiv.innerHTML = '<p class="text-muted">Iniciando análise...</p>';
        exportButton.style.display = 'none';
        progress.style.width = '0%';
        progress.setAttribute('aria-valuenow', 0);

        try {
          const validExtensions = ['txt', 'pdf', 'docx', 'doc', 'rtf', 'odt'];
          const files = Array.from(fileInput.files).filter(file =>
            validExtensions.includes(file.name.split('.').pop().toLowerCase())
          );

          if (files.length < 2) throw new Error('Selecione pelo menos dois arquivos válidos na pasta.');

          const texts = await Promise.all(files.map(async (file) => {
            if (isCancelled) throw new Error('Análise cancelada.');
            try {
              const text = await extractText(file);
              return { fileName: file.webkitRelativePath || file.name, text };
            } catch (error) {
              console.warn(`Ignorando arquivo ${file.name}: ${error.message}`);
              return null;
            }
          }));
          const filteredTexts = texts.filter(text => text !== null);
          if (filteredTexts.length < 2) throw new Error('Não há arquivos suficientes para comparação.');

          progress.style.width = '10%';
          progress.setAttribute('aria-valuenow', 10);

          worker = new Worker('worker.js');
          worker.postMessage({ files: filteredTexts, threshold, ngramSize, metric });

          worker.onmessage = function (e) {
            const { progress: workerProgress, results, error } = e.data;
            if (workerProgress) {
              progress.style.width = `${workerProgress}%`;
              progress.setAttribute('aria-valuenow', workerProgress);
            } else if (error) {
              summaryDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error}</div>`;
            } else {
              displayResults(results);
            }
            startButton.disabled = false;
            cancelButton.disabled = true;
          };

          worker.onerror = function (e) {
            summaryDiv.innerHTML = `<div class="alert alert-danger">Erro no worker: ${e.message}</div>`;
            startButton.disabled = false;
            cancelButton.disabled = true;
            progress.style.width = '0%';
          };
        } catch (error) {
          summaryDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
          startButton.disabled = false;
          cancelButton.disabled = true;
          progress.style.width = '0%';
        }
      }

      function displayResults(results) {
        const resultBody = document.getElementById('resultBody');
        const summaryDiv = document.getElementById('summary');
        const resultTable = document.getElementById('resultTable');
        const noResultsDiv = document.getElementById('noResults');
        const exportButton = document.getElementById('exportButton');

        resultBody.innerHTML = '';
        summaryDiv.innerHTML = '';
        if (results.length === 0) {
          noResultsDiv.style.display = 'block';
          exportButton.style.display = 'none';
        } else {
          resultTable.style.display = 'table';
          noResultsDiv.style.display = 'none';
          exportButton.style.display = 'block';

          const fileOccurrences = {};
          results.forEach(result => {
            fileOccurrences[result.file1] = (fileOccurrences[result.file1] || 0) + 1;
            fileOccurrences[result.file2] = (fileOccurrences[result.file2] || 0) + 1;
          });

          const topFiles = Object.entries(fileOccurrences)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([file, count]) => `<li><em>${file}</em>: ${count} ocorrência${count > 1 ? 's' : ''}</li>`);

          summaryDiv.innerHTML = `
            <h5>Resumo da Análise</h5>
            <p><strong>Total de pares com plágio detectado:</strong> ${results.length}</p>
            <p><strong>Arquivos mais frequentes em plágio:</strong></p>
            <ul>${topFiles.join('') || '<li>Nenhum arquivo frequente</li>'}</ul>
          `;

          results.forEach((result, index) => {
            const row = document.createElement('tr');
            if (parseFloat(result.similarity) >= 50) row.classList.add('high-similarity');
            const excerptId = `excerpt-${index}`;
            const excerpts = result.excerpts.slice(0, 3).map((e, i) => `${i + 1}. ${e}`).join('\n');
            const hasMore = result.excerpts.length > 3;
            row.innerHTML = `
              <td><em>${result.file1}</em></td>
              <td><em>${result.file2}</em></td>
              <td>${result.metric}</td>
              <td>${result.similarity}%</td>
              <td>
                ${result.excerpts.length} trecho${result.excerpts.length !== 1 ? 's' : ''}
                <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#${excerptId}">
                  ${result.excerpts.length > 0 ? 'Ver' : 'Nenhum trecho'}
                </button>
                <div class="collapse excerpt-content mt-2" id="${excerptId}">
                  ${excerpts || 'Nenhum trecho disponível'}
                  ${hasMore ? '<p>(+ ' + (result.excerpts.length - 3) + ' trecho' + (result.excerpts.length - 3 > 1 ? 's' : '') + ')</p>' : ''}
                </div>
              </td>
            `;
            resultBody.appendChild(row);
          });

          window.plagiarismResults = results;
        }
      }

      function cancelAnalysis() {
        isCancelled = true;
        if (worker) worker.terminate();
        document.getElementById('startButton').disabled = false;
        document.getElementById('cancelButton').disabled = true;
        document.getElementById('progress').style.width = '0%';
        document.getElementById('summary').innerHTML = '<p class="text-muted">Análise cancelada.</p>';
      }

      function exportToCSV() {
        if (!window.plagiarismResults || window.plagiarismResults.length === 0) return;
        const headers = ['Arquivo 1', 'Arquivo 2', 'Métrica', 'Similaridade (%)', 'Quantidade de Trechos', 'Trechos Copiados'];
        const rows = window.plagiarismResults.map(result => [
          `"${result.file1}"`,
          `"${result.file2}"`,
          result.metric,
          result.similarity,
          result.excerpts.length,
          `"${result.excerpts.slice(0, 3).join('; ').replace(/"/g, '""')}${result.excerpts.length > 3 ? ' (...)' : ''}"`
        ]);
        const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'plagiarism_results.csv';
        link.click();
        URL.revokeObjectURL(link.href);
      }
    </script>
  </body>
</html>